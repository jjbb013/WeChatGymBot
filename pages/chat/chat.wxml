<!--pages/chat/chat.wxml-->
<view class="chat-container">
  <scroll-view class="message-list" scroll-y="true" scroll-into-view="msg-{{messages.length}}">
<view class="message-item {{item.role}}" id="msg-{{index}}" wx:for="{{messages}}" wx:key="index" bindlongpress="copyText" data-text="{{item.content}}">
  <block wx:if="{{item.role === 'user'}}">
    <view class="content user-content">
      <text user-select>{{item.content}}</text>
    </view>
    <image class="avatar" src="{{userAvatar}}"></image>
  </block>
  <block wx:else>
    <image class="avatar" src="/images/ai-avatar.png"></image>
    <view class="content ai-content">
      <text user-select>{{item.content}}</text>
    </view>
  </block>
</view>
<!-- AI思考中的提示 -->
<view class="message-item ai" id="msg-{{messages.length}}" wx:if="{{isThinking}}">
  <image class="avatar" src="/images/ai-avatar.png"></image>
  <view class="content thinking">
    <view class="dot-flashing"></view>
  </view>
</view>
  </scroll-view>

  <view class="input-area">
    <!-- 语音/键盘切换按钮 -->
    <view class="icon-wrapper" bindtap="switchInputMode">
      <view class="icon {{isVoiceMode ? 'icon-keyboard' : 'icon-voice'}}"></view>
    </view>

    <!-- 输入框核心区域 -->
    <view class="input-wrapper">
      <textarea wx:if="{{!isVoiceMode}}" class="input-field" value="{{inputValue}}" bindinput="handleInput" auto-height show-confirm-bar="{{false}}" cursor-spacing="20" placeholder="输入消息..." bindconfirm="handleTextSend" />
      <button wx:else class="voice-record-btn {{isRecording ? 'recording' : ''}}" hover-class="voice-record-btn-hover" bindtouchstart="handleVoiceRecordStart" bindtouchend="handleVoiceRecordEnd" bindtouchmove="handleVoiceRecordMove">{{isRecording ? '松开 发送' : '按住 说话'}}</button>
    </view>

    <!-- 更多功能按钮 -->
    <view wx:if="{{!showSendButton}}" class="icon-wrapper" bindtap="showMoreFunctions">
      <view class="icon icon-more"></view>
    </view>
    
    <!-- 发送按钮 -->
    <button wx:if="{{showSendButton}}" class="send-btn" bindtap="handleTextSend" disabled="{{isSendButtonDisabled}}">发送</button>
  </view>

  <!-- 语音录制遮罩层 -->
  <view class="voice-record-mask" wx:if="{{isRecording}}">
    <view class="record-ui">
      <view class="record-icon-wrapper">
        <view class="record-icon"></view>
        <!-- 此处可以添加音量变化的动画 -->
        <view class="record-volume-animation" style="height: {{volumeLevel}}%;"></view>
      </view>
      <view class="record-text {{isCancelling ? 'cancel' : ''}}">{{recordStatusText}}</view>
    </view>
  </view>
</view>
